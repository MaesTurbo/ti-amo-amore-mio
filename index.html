<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Ti Amo Amore Mio</title>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden; background: black;
      height: 100vh; width: 100vw;
      font-family: Arial, sans-serif;
    }

    canvas {
      display: block;
    }

    h1 {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-size: 4em;
      font-weight: bold;
      z-index: 10;
      color: red;
      text-shadow: 2px 2px 10px white;
      animation: glow 3s infinite ease-in-out;
      user-select: none;
    }

    @keyframes glow {
      0% { color: red; text-shadow: 0 0 5px red; }
      25% { color: pink; text-shadow: 0 0 10px pink; }
      50% { color: orange; text-shadow: 0 0 20px orange; }
      75% { color: yellow; text-shadow: 0 0 15px yellow; }
      100% { color: red; text-shadow: 0 0 5px red; }
    }

    .heart {
      position: absolute;
      font-size: 20px;
      animation: float 6s infinite ease-in-out;
      user-select: none;
    }

    @keyframes float {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-100vh) scale(1.5);
        opacity: 0;
      }
    }

    #playButton {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      padding: 10px 20px;
      font-size: 1.2em;
      background: crimson;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 10px crimson;
    }
  </style>
</head>
<body>

<h1>TI AMO AMORE MIO</h1>
<canvas id="canvas"></canvas>

<button id="playButton">▶️ Ascolta la musica romantica</button>

<audio id="bgMusic" loop>
  <source src="https://www.bensound.com/bensound-music/bensound-romantic.mp3" type="audio/mpeg" />
  Il tuo browser non supporta l'audio.
</audio>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let W = canvas.width = window.innerWidth;
  let H = canvas.height = window.innerHeight;

  let particles = [];
  let imageData;
  let imgLoaded = false;
  let animationPhase = "falling"; // falling, pause, disperse
  let phaseStartTime = null;
  const pauseDuration = 5 * 60 * 1000; // 5 minuti in ms

  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = "https://raw.githubusercontent.com/MaesTurbo/ti-amo-amore-mio/refs/heads/main/bbb.jpg";

  img.onload = () => {
    const offCanvas = document.createElement("canvas");
    const offCtx = offCanvas.getContext("2d");

    offCanvas.width = W;
    offCanvas.height = H;

    // Manteniamo proporzioni immagine, dimensione circa 60% larghezza schermo
    const aspectRatio = img.width / img.height;
    const imgWidth = W * 0.6;
    const imgHeight = imgWidth / aspectRatio;

    offCtx.drawImage(img, (W - imgWidth) / 2, (H - imgHeight) / 2, imgWidth, imgHeight);
    imageData = offCtx.getImageData(0, 0, W, H);
    imgLoaded = true;

    resetParticles();
    phaseStartTime = performance.now();
  };

  class Particle {
    constructor(x, y, color) {
      this.x = x;
      this.targetY = y;
      this.y = 0;  // partono dall'alto
      this.color = color;
      this.size = 1.5 + Math.random();
      this.speed = 2 + Math.random() * 2;
      this.vx = (Math.random() - 0.5) * 1; // per disperdere dopo
      this.vy = 0;
      this.opacity = 1;
    }

    update(deltaTime) {
      if (animationPhase === "falling") {
        if (this.y < this.targetY) {
          this.y += this.speed;
          if(this.y > this.targetY) this.y = this.targetY;
        }
      } else if (animationPhase === "disperse") {
        // si disperdono verso l'alto con trasparenza che cala
        this.x += this.vx;
        this.y -= 1.5 + Math.random();
        this.opacity -= 0.01;
        if (this.opacity < 0) this.opacity = 0;
      }
    }

    draw() {
      ctx.fillStyle = `rgba(${this.color.r},${this.color.g},${this.color.b},${this.opacity})`;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function resetParticles() {
    particles = [];
    if (!imgLoaded) return;
    for (let y = 0; y < imageData.height; y += 6) {
      for (let x = 0; x < imageData.width; x += 6) {
        const index = (y * imageData.width + x) * 4;
        const r = imageData.data[index];
        const g = imageData.data[index + 1];
        const b = imageData.data[index + 2];
        const a = imageData.data[index + 3];
        if (a > 100) {
          if (Math.random() < 0.3) {
            particles.push(new Particle(x, y, {r, g, b}));
          }
        }
      }
    }
    animationPhase = "falling";
    phaseStartTime = performance.now();
  }

  // Cuori fluttuanti
  setInterval(() => {
    const heart = document.createElement("div");
    heart.className = "heart";
    heart.innerText = "❤️";
    heart.style.left = Math.random() * W + "px";
    heart.style.fontSize = (Math.random() * 30 + 10) + "px";
    heart.style.color = ["red", "pink", "lightblue", "yellow", "green"][Math.floor(Math.random() * 5)];
    heart.style.top = H + "px";
    document.body.appendChild(heart);
    setTimeout(() => heart.remove(), 6000);
  }, 400);

  function animate(time) {
    ctx.clearRect(0, 0, W, H);

    // Aggiorniamo e disegniamo particelle
    particles.forEach(p => p.update(time));
    particles.forEach(p => p.draw());

    // Controlliamo cambio fase
    if(animationPhase === "falling") {
      // Controlla se tutte le particelle hanno raggiunto target
      const allArrived = particles.every(p => p.y >= p.targetY);
      if(allArrived) {
        animationPhase = "pause";
        phaseStartTime = time;
      }
    } else if(animationPhase === "pause") {
      // Aspetta pauseDuration poi passa a disperse
      if(time - phaseStartTime > pauseDuration) {
        animationPhase = "disperse";
        phaseStartTime = time;
      }
    } else if(animationPhase === "disperse") {
      // Controlla se tutte le particelle sono scomparse
      const allGone = particles.every(p => p.opacity <= 0);
      if(allGone) {
        resetParticles();
      }
    }

    requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);

  // Musica play button
  const bgMusic = document.getElementById("bgMusic");
  const playButton = document.getElementById("playButton");

  playButton.onclick = () => {
    bgMusic.play();
    playButton.style.display = "none";
  };

  // Adatta canvas a resize finestra
  window.addEventListener("resize", () => {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  });
</script>

</body>
</html>
