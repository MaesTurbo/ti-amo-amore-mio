<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Ti Amo Amore Mio - Fuochi d'artificio foto</title>
<style>
  body {
    margin: 0; height: 100vh; background: #000;
    display: flex; justify-content: center; align-items: center;
    font-family: 'Arial Black', sans-serif;
    color: white; text-align: center;
    overflow: hidden;
  }
  h1 {
    font-size: 6vw;
    position: relative;
    z-index: 10;
    text-shadow: 0 0 20px #ff3c78;
  }
  canvas#confetti {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 1;
  }
  canvas#imgcanvas {
    display: none;
  }
</style>
</head>
<body>
  <h1>TI AMO AMORE MIO ❤️</h1>

  <!-- Canvas per i fuochi -->
  <canvas id="confetti"></canvas>
  <!-- Canvas nascosto per caricare immagine -->
  <canvas id="imgcanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    const confetti = window.confetti.create(document.getElementById('confetti'), {
      resize: true,
      useWorker: true
    });

    // Link raw github per immagine (modifica se cambi foto)
    const imgURL = "https://raw.githubusercontent.com/MaesTurbo/ti-amo-amore-mio/main/IMG-20200415-WA0007.jpg";

    const imgCanvas = document.getElementById('imgcanvas');
    const imgCtx = imgCanvas.getContext('2d');

    const maxWidth = 100;  // larghezza ridotta per velocità e leggerezza
    const maxHeight = 100;

    function fireworkAt(x, y, color) {
      confetti({
        particleCount: 15,
        startVelocity: 30,
        spread: 45,
        origin: { x: x / window.innerWidth, y: y / window.innerHeight },
        colors: [color],
        shapes: ['circle'],
        ticks: 60,
        scalar: 0.6,
      });
    }

    function loadImageAndExplode() {
      const img = new Image();
      img.crossOrigin = "anonymous"; // per evitare problemi cors
      img.src = imgURL;

      img.onload = () => {
        // Scala canvas immagine per dimensione maxWidth/maxHeight
        let scale = Math.min(maxWidth / img.width, maxHeight / img.height);
        imgCanvas.width = img.width * scale;
        imgCanvas.height = img.height * scale;

        // Disegna immagine scalata
        imgCtx.drawImage(img, 0, 0, imgCanvas.width, imgCanvas.height);

        // Prendi dati pixel immagine
        const imgData = imgCtx.getImageData(0, 0, imgCanvas.width, imgCanvas.height);
        const data = imgData.data;

        // Creiamo una lista di punti con coordinate e colore
        const points = [];
        for (let y = 0; y < imgCanvas.height; y++) {
          for (let x = 0; x < imgCanvas.width; x++) {
            let idx = (y * imgCanvas.width + x) * 4;
            let r = data[idx];
            let g = data[idx + 1];
            let b = data[idx + 2];
            let a = data[idx + 3];
            if (a > 128) { // consideriamo pixel non trasparenti
              points.push({ x, y, color: `rgb(${r},${g},${b})` });
            }
          }
        }

        // Funzione per lanciare fuochi a gruppi (per non bloccare)
        let i = 0;
        function launchBatch() {
          const batchSize = 10; // quanti fuochi per batch
          for (let j = 0; j < batchSize && i < points.length; j++, i++) {
            let p = points[i];
            // Convertiamo coordinate immagine in coordinate schermo
            let screenX = p.x / imgCanvas.width * window.innerWidth;
            let screenY = p.y / imgCanvas.height * window.innerHeight;

            fireworkAt(screenX, screenY, p.color);
          }
          if (i < points.length) {
            setTimeout(launchBatch, 200);
          }
        }

        launchBatch();
      };
    }

    loadImageAndExplode();
  </script>
</body>
</html>
